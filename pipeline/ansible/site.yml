# NOTE: In `lineinfile`, `dest` will become `path`.
---
- hosts: rails
  remote_user: ubuntu
  become: yes
  tasks:
    - name: Update all packages to the latest version
      apt:
        upgrade: dist
    - name: Add deploy user
      user:
        name: deploy
        shell: /bin/bash
    - name: Add SSH key to server for deploy
      # TODO: User a loop later on.
      authorized_key:
        user: deploy
        key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDZN5iRBIeW4pVvZI4TVwKW7UeeLhd/cyxXKXCtm6NSqiJhOwmbLnVdvnMAwmBU5GZarQk0GAsRY3Y7SNZvG6inBKy5QaoP56Tb3hXYYElizyS0Ox4RTPE5p8ARXa+4vtF+i1crwBLYPJkle1xOZWdQCKkWC9XjPpCHtZlXP8Fsm06A2FhAjw1O20SEJOHnrRSJi+AnrZiTJlZC33BDC0SvVSn3pJdjvFRO6okRgRyIpk6lqcnX3W/czU2rthjPn7J68H74pCh0C6U6jDoZAJg0i8r+uFI+8a3k5fLWmpUyZwwyD/3pzmXb0o3k5Ahgmt/PYAtxmKsAXhs2IzVIbN++KHIMnnvFzJQBkhnQY0x0PishpfkK6X4wQgVFhLeY5seNm2iYPecQCNrg4V2GqSWN1f2sDDDZ+ELnp2EdfEDVvgxWIbGzJaIYBUoblM03ahIMSLyLwPHQfnU4fg8mp6fGAB+7yIgeWIaCq7HyWF6mLFD2ohZAq+2qCJvideJBcjxUU2grofwjfbxEI8ZXKoJKAh6vq9JweVaNe44JTyIgLxE/XV5ZDMO6m7MI7I+TbSivzK8l9FdfnaMjrsHNkPSTp2QMvi/abVxOuUjZYL2+6tb7Jl8Qgh4oMQKRqZBh5wMdz2UcUHIMzFyvTZSSjDCXE/0ZViisbzWjLxjKJ5luWQ== caioergos@gmail.com"
    - name: Install Ruby dependencies
      # TODO: User a loop later on.
      apt:
        name: "{{ item }}"
      with_items:
         - gcc
         - autoconf
         - bison
         - build-essential
         - libssl-dev
         - libyaml-dev
         - libreadline6-dev
         - zlib1g-dev
         - libncurses5-dev
         - libffi-dev
         - libgdbm3
         - libgdbm-dev
         - sqlite3
         - libsqlite3-dev
         - nodejs
    - name: Download ruby-install
      become: no
      get_url:
        url: https://github.com/postmodern/ruby-install/archive/v0.7.0.tar.gz
        dest: /home/ubuntu/ruby-install-0.7.0.tar.gz
    - name: Extract ruby-install tarball
      become: no
      unarchive:
        src: /home/ubuntu/ruby-install-0.7.0.tar.gz
        dest: /home/ubuntu
        creates: /home/ubuntu/ruby-install-0.7.0
        remote_src: yes
    - name: Install ruby-install
      make:
        chdir: /home/ubuntu/ruby-install-0.7.0
        target: install
    - name: Install Ruby
      become_user: deploy
      command: /usr/local/bin/ruby-install --no-install-deps ruby 2.5.0
      args:
        creates: /home/deploy/.rubies/ruby-2.5.0
    - name: Download chruby
      become: no
      get_url:
        url: https://github.com/postmodern/chruby/archive/v0.3.9.tar.gz
        dest: /home/ubuntu/chruby-0.3.9.tar.gz
    - name: Extract chruby tarball
      become: no
      unarchive:
        src: /home/ubuntu/chruby-0.3.9.tar.gz
        dest: /home/ubuntu
        creates: /home/ubuntu/chruby-0.3.9
        remote_src: yes
    - name: Install chruby
      make:
        chdir: /home/ubuntu/chruby-0.3.9
        target: install
    - name: Load chruby for deploy user
      lineinfile:
        dest: /home/deploy/.bashrc
        regexp: 'chruby.sh$'
        line: 'source /usr/local/share/chruby/chruby.sh'
        insertbefore: BOF
    - name: Set ruby version for deploy user
      lineinfile:
        dest: /home/deploy/.profile
        regexp: '^chruby'
        line: 'chruby ruby-2.5.0'
    - name: Install bundler
      become_user: deploy
      command: 'chruby-exec ruby-2.5.0 -- gem install bundler'
      args:
        creates: /home/deploy/.gem/ruby/2.5.0/bin/bundle
    - name: Install nginx
      apt:
        name: nginx
        state: latest
